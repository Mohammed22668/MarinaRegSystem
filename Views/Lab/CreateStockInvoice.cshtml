@model CreateStockInvoiceViewModel

@{
    Layout = "_LayoutLab";
    ViewData["Title"] = "أنشاء تصنيف";
}

@section Head {

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
        <link rel="shortcut icon" href="~/assets/img/favicon.png">
        <title>لوحة تحكم مختبر مارينا - مستشفى مارينا</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/bootstrap.rtl.min.css">

        <!-- Fontawesome CSS -->
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/fontawesome.min.css">
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/all.min.css">

        <!-- Select2 CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/select2.min.css">

        <!-- Datatables CSS -->
        <link rel="stylesheet" href="~/assets/plugins/datatables/datatables.min.css">

        <!-- Feathericon CSS -->
        <link rel="stylesheet" href="~/assets/css/feather.css">

        <!-- Main CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/style.css">

        <!-- Animate -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

        <style>
            .card {
                transition: all 0.3s ease;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, .12), 0 4px 8px rgba(0, 0, 0, .06);
            }

            .card-body .display-4 {
                transition: all 0.3s ease;
            }

            .card:hover .card-body .display-4 {
                transform: scale(1.1);
            }
        </style>


    </head>
}

@section currentPage {
    <li class="menu-side"><img src="~/assets/img/icons/menu-icon-04.svg" alt=""></li>
    <li class="breadcrumb-item" style="margin-right:10px"><a href="#" style="font-weight:bolder">حجوزات المختبر </a></li>
}
<div class="container py-5">

    <div class="container py-4">
        <h4 class="mb-4 text-center text-primary">إنشاء فاتورة مخزون</h4>

        <form asp-action="CreateStockInvoice" method="post">
            <div class="mb-3">
                <label class="form-label">رقم الفاتورة</label>
                <input asp-for="InvoiceNumber" class="form-control" required />
            </div>

            <div class="mb-3">
                <label class="form-label">تاريخ الفاتورة</label>
                <input asp-for="InvoiceDate" type="datetime-local" class="form-control" />
            </div>

            <hr />

            <h5 class="mb-3">تفاصيل المواد المضافة</h5>

            <table class="table table-bordered" id="items-table">
                <thead class="table-light">
                    <tr>
                        <th>اسم التحليل</th>
                        <th>الكمية</th>
                        <th>ملاحظات</th>
                        <th>تاريخ انتهاء الصلاحية</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td>
                                <select name="Items[@i].LabTestId" class="form-control" required>
                                    <option value="">-- اختر التحليل --</option>
                                  @foreach (var test in Model.AvailableLabTests)
{
    if (test.Id == Model.Items[i].LabTestId)
    {
        <option value="@test.Id" selected="selected">@test.Name</option>
    }
    else
    {
        <option value="@test.Id">@test.Name</option>
    }
}
                                </select>
                            </td>
                            <td>
                                <input name="Items[@i].QuantityAdded" type="number" step="0.01"
                                    value="@Model.Items[i].QuantityAdded" class="form-control" required />
                            </td>
                            <td>
                                <input name="Items[@i].Notes" value="@Model.Items[i].Notes" class="form-control" />
                            </td>
                            <td>
                                <input name="Items[@i].ExpiryDate" type="date"
                                    value="@(Model.Items[i].ExpiryDate?.ToString("yyyy-MM-dd"))" class="form-control" />
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm btn-remove-row">حذف</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <button type="button" id="btn-add-row" class="btn btn-success">إضافة تحليل جديد</button>

            <button type="submit" class="btn btn-primary mt-3">حفظ الفاتورة</button>
        </form>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const tableBody = document.querySelector("#items-table tbody");
            const addRowBtn = document.getElementById("btn-add-row");

            // البيانات الأولية لـ AvailableLabTests من Razor إلى JS
            const labTests = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AvailableLabTests));

            // وظيفة لإضافة صف جديد مع حقول فارغة
            function addRow(index) {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                        <td>
                            <select name="Items[${index}].LabTestId" class="form-control" required>
                                <option value="">-- اختر التحليل --</option>
                                ${labTests.map(test => `<option value="${test.id}">${test.name}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <input name="Items[${index}].QuantityAdded" type="number" step="0.01" class="form-control" required />
                        </td>
                        <td>
                            <input name="Items[${index}].Notes" class="form-control" />
                        </td>
                        <td>
                            <input name="Items[${index}].ExpiryDate" type="date" class="form-control" />
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm btn-remove-row">حذف</button>
                        </td>
                    `;

                tableBody.appendChild(tr);
            }

            // إعادة ترقيم أسماء الحقول بعد حذف/إضافة صف
            function renameRows() {
                const rows = tableBody.querySelectorAll("tr");
                rows.forEach((tr, idx) => {
                    const selects = tr.querySelectorAll("select, input");
                    selects.forEach(el => {
                        const name = el.getAttribute("name");
                        const newName = name.replace(/Items\[\d+\]/, `Items[${idx}]`);
                        el.setAttribute("name", newName);
                    });
                });
            }

            // حدث حذف صف
            tableBody.addEventListener("click", function (e) {
                if (e.target.classList.contains("btn-remove-row")) {
                    e.target.closest("tr").remove();
                    renameRows();
                }
            });

            // حدث إضافة صف جديد
            addRowBtn.addEventListener("click", function () {
                const currentRows = tableBody.querySelectorAll("tr").length;
                addRow(currentRows);
            });
        })();
    </script>
}


@section Footer {
    <!-- jQuery -->
    <script src="~/assets/js/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>

    <!-- Feather Js -->
    <script src="~/assets/js/feather.min.js"></script>

    <!-- Slimscroll -->
    <script src="~/assets/js/jquery.slimscroll.js"></script>

    <!-- Select2 Js -->
    <script src="~/assets/js/select2.min.js"></script>

    <!-- Datepicker JS -->
    <script src="~/assets/plugins/moment/moment.min.js"></script>
    <script src="~/assets/js/bootstrap-datetimepicker.min.js"></script>

    <!-- Custom JS -->
    <script src="~/assets/js/script.js"></script>

    <!-- Validation Scripts -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
}
