@model DoctorScheduleCalendarViewModel
@using Newtonsoft.Json

@{
    ViewData["Title"] = "جدول دوام الأطباء - حسب القسم الفرعي";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var subDepartments = Model.SubDepartments;
    var eventsBySubDepartment = Model.EventsBySubDepartment;
}

@section Head {

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
        <link rel="shortcut icon" type="image/x-icon" href="~/assets/img/favicon.png">
        <title>مستشفى مارينا - الرئيسية</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/bootstrap.rtl.min.css">

        <!-- Fontawesome CSS -->
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/fontawesome.min.css">
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/all.min.css">

        <!-- Select2 CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/select2.min.css">

        <!-- Datatables CSS -->
        <link rel="stylesheet" href="~/assets/plugins/datatables/datatables.min.css">

        <!-- Feathericon CSS -->
        <link rel="stylesheet" href="~/assets/css/feather.css">

        <!-- Main CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/style.css">

        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.min.js"></script>

        <!-- ملفات Bootstrap 5 الضرورية -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            .subdept-tabs {
                border-bottom: 2px solid #e9ecef;
                margin-bottom: 20px;
            }

            .nav-tabs .nav-link {
                font-weight: 600;
                color: #6c757d;
                border: none;
                border-bottom: 3px solid transparent;
                padding: 12px 20px;
                margin-left: 5px;
                margin-right: 5px;
                border-radius: 0;
                transition: all 0.3s ease;
                background-color: transparent;
            }

            .nav-tabs .nav-link:hover {
                color: #0d6efd;
                background-color: #f8f9fa;
                border-color: transparent;
            }

            .nav-tabs .nav-link.active {
                color: #0d6efd;
                border-bottom: 3px solid #0d6efd;
                background-color: #fff;
            }

            .tab-content {
                background: #fff;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.08);
                padding: 25px;
                margin-bottom: 30px;
            }

            .calendar-container {
                min-height: 600px;
            }

            /* تحسين مظهر الكالندر */
            .fc {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }

            .fc-toolbar-title {
                font-weight: 600;
                color: #333;
            }

            .fc-button {
                background-color: #0d6efd;
                border-color: #0d6efd;
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .fc-button:hover {
                background-color: #0b5ed7;
                border-color: #0a58ca;
            }

            .fc-event {
                border-radius: 6px;
                border: none;
                padding: 3px 6px;
                font-size: 0.8rem;
                font-weight: 500;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .fc-timegrid-event {
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

            /* تحسين مظهر الجدول */
            .fc-scrollgrid {
                border: 1px solid #e9ecef;
                border-radius: 8px;
                overflow: hidden;
            }

            .fc-timegrid-axis {
                background-color: #f8f9fa;
            }

            .calendar-container {
                min-height: 600px;
                background-color: #ffffff;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            [id^="calendar-"] {
                min-height: 500px;
                width: 100% !important;
            }

            .fc {
                min-height: 450px;
            }
        </style>
    </head>
}

@section currentPage {
    <li class="menu-side"><img src="~/assets/img/icons/menu-icon-04.svg" alt=""></li>
    <li class="breadcrumb-item" style="vertical-align:middle;margin-right:10px"><a href="#"
            style="font-weight:bolder">الأطباء</a></li>
}



<div class="container mt-5">


    <!-- تبويبات الأقسام الفرعية -->
    <div class="subdept-tabs">
        <ul class="nav nav-tabs mb-4" id="subDeptTabs" role="tablist">
            @for (int i = 0; i < subDepartments.Count; i++)
            {
                var subDept = subDepartments[i];
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(i == 0 ? "active" : "")" id="tab-@subDept.Id" data-bs-toggle="tab"
                        data-bs-target="#content-@subDept.Id" type="button" role="tab" aria-controls="content-@subDept.Id"
                        aria-selected="@(i == 0 ? "true" : "false")">
                        @subDept.Name
                    </button>
                </li>
            }
        </ul>
    </div>

    <!-- محتوى التبويبات -->
    <div class="tab-content" id="subDeptTabsContent">
        @for (int i = 0; i < subDepartments.Count; i++)
        {
            var subDept = subDepartments[i];
            var deptEvents = eventsBySubDepartment.ContainsKey(subDept.Id) ? eventsBySubDepartment[subDept.Id] : new
            List<DoctorScheduleEvent>();
            var calId = $"calendar-{subDept.Id}";

            <div class="tab-pane fade @(i == 0 ? "show active" : "")" id="content-@subDept.Id" role="tabpanel"
                aria-labelledby="tab-@subDept.Id">
                <div class="calendar-container">
                    <div id="@calId" data-events='@Html.Raw(JsonConvert.SerializeObject(deptEvents))'
                        style="width: 100%; min-height: 500px;">
                    </div>
                </div>
            </div>
        }
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let activeCalendar = null;

            // دالة لإنشاء كائن الكالندر بدون رسمه فورًا
            function createCalendar(calendarEl) {
                const eventsJson = calendarEl.getAttribute('data-events');
                const events = eventsJson ? JSON.parse(eventsJson) : [];

                return new FullCalendar.Calendar(calendarEl, {
                    locale: 'ar',
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridDay,timeGridWeek,listWeek'
                    },
                    allDaySlot: false,
                    slotMinTime: '08:00:00',
                    slotMaxTime: '22:00:00',
                    height: 'auto',
                    events: events,
                    direction: 'rtl'
                });
            }

            // دالة لعرض الكالندر في التبويب الحالي
            function showCalendar(tabId) {
                // إخفاء الكالندر السابق إن وجد
                if (activeCalendar) {
                    activeCalendar.destroy();
                    activeCalendar = null;
                }

                // إيجاد عنصر الكالندر في التبويب المحدد
                const targetPane = document.querySelector(tabId);
                if (targetPane) {
                    const calendarDiv = targetPane.querySelector('div[id^="calendar-"]');
                    if (calendarDiv) {
                        // إنشاء وعرض الكالندر
                        activeCalendar = createCalendar(calendarDiv);
                        activeCalendar.render();
                    }
                }
            }

            // عند تبديل التبويب
            const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabButtons.forEach(tabBtn => {
                tabBtn.addEventListener('click', function (e) {
                    const targetTabId = this.getAttribute('data-bs-target');
                    // استخدام setTimeout لضمان أن التبويب أصبح نشطًا
                    setTimeout(() => {
                        showCalendar(targetTabId);
                    }, 50);
                });
            });

            // عرض الكالندر للتبويب الأول عند التحميل
            const firstTabBtn = document.querySelector('button[data-bs-toggle="tab"].active');
            if (firstTabBtn) {
                const firstTabId = firstTabBtn.getAttribute('data-bs-target');
                setTimeout(() => {
                    showCalendar(firstTabId);
                }, 100);
            }
        });
    </script>
}
@section Footer {
    <!-- jQuery -->
    <script src="~/assets/js/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>

    <!-- Feather Js -->
    <script src="~/assets/js/feather.min.js"></script>

    <!-- Slimscroll -->
    <script src="~/assets/js/jquery.slimscroll.js"></script>

    <!-- Select2 Js -->
    <script src="~/assets/js/select2.min.js"></script>

    <!-- Datepicker JS -->
    <script src="~/assets/plugins/moment/moment.min.js"></script>
    <script src="~/assets/js/bootstrap-datetimepicker.min.js"></script>

    <!-- Custom JS -->
    <script src="~/assets/js/script.js"></script>

    <!-- Validation Scripts -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
}