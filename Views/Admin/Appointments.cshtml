@* @model IEnumerable<MarinaRegSystem.Models.Appointment> *@
@model MarinaRegSystem.Models.AppointmentFilterViewModel
@using MarinaRegSystem.Helpers
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "الحجوزات";
}



@section Head {

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
        <link rel="shortcut icon" href="~/assets/img/favicon.png">
        <title>لوحة تحكم الأدمن - مستشفى مارينا</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/bootstrap.rtl.min.css">

        <!-- Fontawesome CSS -->
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/fontawesome.min.css">
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/all.min.css">

        <!-- Select2 CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/select2.min.css">

        <!-- Datatables CSS -->
        <link rel="stylesheet" href="~/assets/plugins/datatables/datatables.min.css">

        <!-- Feathericon CSS -->
        <link rel="stylesheet" href="~/assets/css/feather.css">

        <!-- Main CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/style.css">

        <!-- Animate -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />


        <style>
            .table th {
                background-color: #f1f4f7;
                color: #3b3f5c;
                font-weight: bold;
                text-align: center;
                vertical-align: middle;
            }

            .table td {
                text-align: center;
                vertical-align: middle;
            }

            .table-avatar a {
                display: flex;
                align-items: center;
                gap: 10px;
                text-decoration: none;
            }

            .table-avatar img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

            .rating i {
                font-size: 1rem;
            }

            .actions .btn {
                padding: 5px 10px;
                font-size: 0.85rem;
                border-radius: 6px;
            }

            .bg-success-light {
                background-color: #d4edda;
                color: #155724;
            }

            .bg-danger-light {
                background-color: #f8d7da;
                color: #721c24;
            }

            .btn-primary i {
                margin-left: 5px;
            }

            .page-title {
                font-weight: 700;
                color: #3b3f5c;
                font-size: 1.75rem;
            }

            .badge {
                font-size: 0.85rem;
                padding: 6px 12px;
                border-radius: 50px;
            }
        </style>

    </head>
}

@section currentPage {
    <li class="menu-side"><img src="~/assets/img/icons/menu-icon-04.svg" alt=""></li>
    <li class="breadcrumb-item" style="margin-right:10px"><a href="#" style="font-weight:bolder">الحجوزات </a></li>
}





<!-- 🔍 نموذج البحث والفلترة -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title mb-4 text-primary">
            <i class="fas fa-filter me-2"></i> فلترة الحجوزات
        </h5>

        <form method="get" asp-action="Appointments">
            <div class="row g-3">
                <div class="col-md-4 col-lg-3">
                    <label class="form-label">اسم المريض</label>
                    <input type="text" name="PatientName" value="@Model.PatientName" class="form-control"
                        placeholder="اسم المريض" />
                </div>

                <div class="col-md-4 col-lg-3">
                    <label class="form-label">اسم الطبيب</label>
                    <input type="text" name="DoctorName" value="@Model.DoctorName" class="form-control"
                        placeholder="اسم الطبيب" />
                </div>

                <div class="col-md-4 col-lg-3">
                    <label class="form-label">القسم</label>
                    <select name="DepartmentId" class="form-select">
                        <option value="">-- اختر القسم --</option>
                        @foreach (var dept in Model.Departments)
                        {
                            <option value="@dept.Value" selected="@(dept.Value == Model.DepartmentId?.ToString())">
                                @dept.Text</option>
                        }
                    </select>
                </div>

                <div class="col-md-6 col-lg-3">
                    <label class="form-label">الحالة</label>
                    <select name="Status" class="form-select">
                        <option value="">-- اختر الحالة --</option>
                        @foreach (var item in EnumExtensions.ToSelectList<MarinaRegSystem.Models.AppointmentStatus>())
                        {
                            <option value="@item.Value" selected="@(item.Value == Model.Status?.ToString())">@item.Text
                            </option>
                        }
                    </select>
                </div>

                <div class="col-md-6 col-lg-3">
                    <label class="form-label">من تاريخ</label>
                    <input type="date" name="FromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))"
                        class="form-control" />
                </div>

                <div class="col-md-6 col-lg-3">
                    <label class="form-label">إلى تاريخ</label>
                    <input type="date" name="ToDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))"
                        class="form-control" />
                </div>

                <div class="col-md-6 col-lg-3 d-grid align-self-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i> بحث
                    </button>
                </div>

                <div class="col-md-6 col-lg-3 d-grid align-self-end">
                    <button type="submit" name="export" value="excel" class="btn btn-success">
                        <i class="fas fa-file-excel me-1"></i> تصدير إلى Excel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- تبويبات الحجوزات -->
<ul class="nav nav-pills nav-justified mb-4 bg-light p-1 rounded shadow-sm" id="appointmentTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active rounded-pill" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming"
            type="button" role="tab">
            <i class="fas fa-calendar-check me-1"></i> الحجوزات الحالية / القادمة
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button"
            role="tab">
            <i class="fas fa-history me-1"></i> الحجوزات السابقة
        </button>
    </li>
</ul>
<div class="tab-content" id="appointmentTabsContent">
    <!-- التبويب الأول: الحالية والقادمة -->
    <div class="tab-pane fade show active" id="upcoming" role="tabpanel">
        @await Html.PartialAsync("_AppointmentsTable", Model.Results.Where(r => r.Appointment.Status ==
        AppointmentStatus.Pending || r.Appointment.Status == AppointmentStatus.Confirmed).OrderByDescending(r =>
        r.Appointment.AppointmentDate).ThenByDescending(r => r.Appointment.AppointmentTime).ToList())
    </div>

    <!-- التبويب الثاني: السابقة -->
    <div class="tab-pane fade" id="past" role="tabpanel">
        @await Html.PartialAsync("_AppointmentsTable", Model.Results.Where(r => r.Appointment.Status !=
                AppointmentStatus.Pending && r.Appointment.Status != AppointmentStatus.Confirmed).OrderByDescending(r =>
                r.Appointment.AppointmentDate).ThenByDescending(r => r.Appointment.AppointmentTime).ToList())
    </div>
</div>



@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.btn-delete');

            deleteButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const appointmentId = this.getAttribute('data-id');

                    Swal.fire({
                        title: 'هل أنت متأكد؟',
                        text: "لن تتمكن من التراجع عن هذا الحذف!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'نعم، احذف!',
                        cancelButtonText: 'إلغاء'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // ارسال طلب الحذف عن طريق الفورم برمجياً أو إعادة توجيه
                            // الطريقة الأسهل: عمل فورم وحذف برمجي

                            // إنشاء فورم مؤقت للحذف (POST)
                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = `/Admin/DeleteAppointment/${appointmentId}`;

                            // إضافة مفتاح الحماية ضد الهجمات CSRF (إذا كنت تستخدمه)
                            const token = document.querySelector('input[name="__RequestVerificationToken"]');
                            if (token) {
                                const hiddenInput = document.createElement('input');
                                hiddenInput.type = 'hidden';
                                hiddenInput.name = '__RequestVerificationToken';
                                hiddenInput.value = token.value;
                                form.appendChild(hiddenInput);
                            }

                            document.body.appendChild(form);
                            form.submit();
                        }
                    });
                });
            });
        });
    </script>


}



@section Footer {
    <!-- jQuery -->
    <script src="~/assets/js/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="~/assets/js/bootstrap.bundle.min.js"></script>

    <!-- Feather Js -->
    <script src="~/assets/js/feather.min.js"></script>

    <!-- Slimscroll -->
    <script src="~/assets/js/jquery.slimscroll.js"></script>

    <!-- Select2 Js -->
    <script src="~/assets/js/select2.min.js"></script>

    <!-- Datepicker JS -->
    <script src="~/assets/plugins/moment/moment.min.js"></script>
    <script src="~/assets/js/bootstrap-datetimepicker.min.js"></script>

    <!-- Custom JS -->
    <script src="~/assets/js/script.js"></script>

    <!-- Validation Scripts -->
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
}