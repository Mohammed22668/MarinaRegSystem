@model MarinaRegSystem.Models.Appointment
@{
    Layout = "_LayoutPatient";
    ViewData["Title"] = "حجز موعد";
}

@section currentPage {
    <li class="breadcrumb-item active"> حجز موعد</li>
}


@section Head {
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
        <link rel="shortcut icon" type="image/x-icon" href="~/assets/img/favicon.png">
        <title>مستشفى مارينا - الرئيسية</title>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/bootstrap.rtl.min.css">

        <!-- Fontawesome CSS -->
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/fontawesome.min.css">
        <link rel="stylesheet" href="~/assets/plugins/fontawesome/css/all.min.css">

        <!-- Select2 CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/select2.min.css">

        <!-- Datatables CSS -->
        <link rel="stylesheet" href="~/assets/plugins/datatables/datatables.min.css">

        <!-- Feathericon CSS -->
        <link rel="stylesheet" href="~/assets/css/feather.css">

        <!-- Main CSS -->
        <link rel="stylesheet" type="text/css" href="~/assets/css/style.css">

    </head>
}


<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .form-container {
        max-width: 700px;
        margin: auto;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        background-color: white;
    }

    .form-heading {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .form-label {
        font-weight: bold;
    }

    .input-block {
        margin-bottom: 1rem;
    }

    .btn-submit {
        border-radius: 50px;
        padding: 0.6rem 2rem;
        font-weight: bold;
    }

    .select2-container .select2-selection {
        height: 45px !important;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        border-radius: 0.375rem;
    }

    .cal-icon .input-group-text,
    .time-icon .input-group-text {
        cursor: pointer;
    }
</style>


<div class="container mt-5">
    <div class="form-container">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success text-center">@TempData["SuccessMessage"]</div>
        }

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
        }

        <h4 class="form-heading">حجز موعد مع الطبيب</h4>

        <form asp-action="AddSchedule" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <!-- القسم -->
            <div class="input-block">
                <label asp-for="DepartmentId" class="form-label">القسم<span class="text-danger">*</span></label>
                <select asp-for="DepartmentId" class="form-control select2" id="DepartmentId" name="DepartmentId" asp-items="ViewBag.Departments">
                    <option value="">اختر القسم</option>
                </select>
                <span asp-validation-for="DepartmentId" class="text-danger"></span>
            </div>

            <!-- شفت الدوام -->
            <div class="input-block">
                <label for="Shift" class="form-label">شفت الدوام</label>
                <select id="Shift" name="Shift" class="form-control select2">
                    <option value="">اختر الشفت</option>
                    <option value="0">صباحي</option>
                    <option value="1">مسائي</option>
                    <option value="2">خفر</option>
                </select>
            </div>

            <!-- الطبيب -->
            <div class="input-block">
                <label asp-for="DoctorId" class="form-label">الطبيب<span class="text-danger">*</span></label>
                <select asp-for="DoctorId" class="form-control select2" id="DoctorId" name="DoctorId">
                    <option value="">اختر الطبيب</option>
                </select>
                <span asp-validation-for="DoctorId" class="text-danger"></span>
            </div>

            <!-- التاريخ -->
            <div class="input-block">
                <label asp-for="AppointmentDate" class="form-label">تاريخ الحجز<span class="text-danger">*</span></label>
                <div class="input-group">
                    <input asp-for="AppointmentDate" class="form-control datetimepicker" type="date" data-date-format="DD/MM/YYYY" placeholder="اختر التاريخ">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                </div>
                <span asp-validation-for="AppointmentDate" class="text-danger"></span>
            </div>

            <!-- الوقت -->
            <div class="input-block">
                <label asp-for="AppointmentTime" class="form-label">وقت الحجز<span class="text-danger">*</span></label>
                <div class="input-group">
                    <input asp-for="AppointmentTime" class="form-control timepicker" type="time" placeholder="اختر الوقت">
                    <span class="input-group-text"><i class="far fa-clock"></i></span>
                </div>
                <span asp-validation-for="AppointmentTime" class="text-danger"></span>
            </div>

            <!-- ملف التشخيص -->
            <div class="input-block">
                <label class="form-label">ملف التشخيص (PDF أو صورة)</label>
                <input type="file" name="diagnosisFile" class="form-control" accept=".pdf,image/*">
            </div>

            <!-- زر الإرسال -->
            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-submit">
                    <i class="fas fa-calendar-check me-1"></i> حجز الموعد
                </button>
            </div>
        </form>
    </div>

    <div class="text-center mt-4">
        <a href="@Url.Action("Index", "Patient")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> العودة إلى الصفحة الرئيسية
        </a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // تهيئة Select2
            $('.select2').select2({
                placeholder: "اختر من القائمة",
                allowClear: true,
                dir: "rtl"
            });

            // تهيئة Datepicker
            $('.datetimepicker').datetimepicker({
                format: 'DD/MM/YYYY',
                locale: 'ar',
                useCurrent: false,
                minDate: moment(),
                icons: {
                    date: 'fa fa-calendar'
                }
            });

            // تهيئة Timepicker
            $('.timepicker').datetimepicker({
                format: 'HH:mm',
                locale: 'ar',
                stepping: 30,
                minTime: '08:00',
                maxTime: '20:00',
                defaultTime: '08:00',
                showTodayButton: false,
                toolbarPlacement: 'bottom',
                icons: {
                    time: 'fa fa-clock'
                }
            });

            // عند تغير القسم أو الشفت يتم تحديث قائمة الأطباء
            $('#DepartmentId, #Shift').change(function () {
                var departmentId = $('#DepartmentId').val();
                var shift = $('#Shift').val();

                if (!departmentId) {
                    $('#DoctorId').empty().append('<option value="">اختر الطبيب</option>');
                    return;
                }

                $.ajax({
    url: '/Appointment/GetDoctorsByDepartmentAndShift',
    data: { departmentId: departmentId, shift: shift },
    success: function (data) {
        console.log('Received doctors:', data); // تحقق من البيانات في Console
        var doctorSelect = $('#DoctorId');
        doctorSelect.empty().append('<option value="">اختر الطبيب</option>');

        $.each(data, function (index, doctor) {
            doctorSelect.append($('<option></option>').val(doctor.id).text(doctor.name));
        });
        doctorSelect.trigger('change');
    },
    error: function () {
        alert('حدث خطأ أثناء جلب الأطباء. حاول مرة أخرى.');
    }
});
            });
        });
    </script>
}




@section Footer{
   <!-- jQuery -->
<script src="~/assets/js/jquery-3.7.1.min.js"></script>

<!-- Bootstrap JS -->
<script src="~/assets/js/bootstrap.bundle.min.js"></script>

<!-- Feather Js -->
<script src="~/assets/js/feather.min.js"></script>

<!-- Slimscroll -->
<script src="~/assets/js/jquery.slimscroll.js"></script>

<!-- Select2 Js -->
<script src="~/assets/js/select2.min.js"></script>

<!-- Datepicker JS -->
<script src="~/assets/plugins/moment/moment.min.js"></script>
<script src="~/assets/js/bootstrap-datetimepicker.min.js"></script>

<!-- Custom JS -->
<script src="~/assets/js/script.js"></script>

<!-- Validation Scripts -->
<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
}